# å®‰å…¨åŠ å›º - é¿å…ä½¿ç”¨æ ¹ç”¨æˆ·

è¿˜è®°å¾—æœ€æ—©æˆ‘ä»¬æåˆ°çš„ã€Œ*æš‚æ—¶* ä½œä¸º `root`ï¼ˆæ ¹ï¼‰ç”¨æˆ·ç™»å½•ã€å—ã€‚åœ¨æœ¬èŠ‚ï¼Œæˆ‘å°†å¸¦é¢†å¤§å®¶åˆ›å»ºæ–°ç”¨æˆ·ã€‚

## ä¸ºä½•è¿™ä¹ˆåšï¼Ÿ

ä¸¥æ ¼åœ°è¯´ï¼Œå¹¶ä¸æ˜¯ä¸å…è®¸ä½¿ç”¨æ ¹ç”¨æˆ·ï¼›è€Œæ˜¯ **ç¦æ­¢ç›´æ¥ä½œä¸ºæ ¹ç”¨æˆ·ç™»å½•åˆ°æœåŠ¡å™¨**ã€‚åŸå› å¦‚ä¸‹ï¼š

- é¿å…éšæ‰‹ `rm -rf /` æˆ–æ˜¯ `rm -rf . /` ä¹‹ç±»çš„æ‚²å‰§ã€‚
- æ›´åŠ å®‰å…¨åœ°ä½¿ç”¨ Composerï¼Œå°½å¯èƒ½å‡å°‘æ‰©å±•åŒ…ä½œè€…æˆ–ä¸­é—´äººåŠ«æŒæ’å…¥çš„æ¶æ„ä»£ç åœ¨ä¾èµ–å®‰è£…æˆ–æ›´æ–°æ—¶è¢«æ‰§è¡Œå¯¹æœåŠ¡å™¨é€ æˆçš„å½±å“ã€‚
- æ›´åŠ å®‰å…¨åœ°ç™»å½•æœåŠ¡å™¨ï¼Œå³ä½¿å¯†é’¥æ³„éœ²ï¼Œä¸æ³•åˆ†å­ï¼ˆğŸ˜‚ï¼‰ä¹Ÿä¸èƒ½ç›´æ¥ä½œä¸ºæ ¹ç”¨æˆ·ç™»å½•ï¼Œæ— æ³•ç›´æ¥å–å¾—ç®¡ç†æƒé™ã€‚
- åç»­è¯¾ç¨‹ä¸­ï¼Œæ›´åŠ å®‰å…¨åœ°ä½¿ç”¨ Deployer å’Œ Ansibleã€‚
- ...

å¯ä»¥çœ‹å‡ºï¼Œå‡ ä¹æ‰€æœ‰çš„å› ç´ éƒ½ä¸ **å®‰å…¨** ç›´æ¥æŒ‚é’©ã€‚

## åˆ›å»ºæ–°ç”¨æˆ·

åœ¨åˆ›å»ºç”¨æˆ·ä¹‹å‰ï¼Œè¯·å…ˆæ–°å»ºç”¨æˆ·ç»„ï¼Œä¾‹å¦‚ `deployment`ï¼š

```bash
$ addgroup deployment
```

éšååˆ›å»ºæ–°ç”¨æˆ·ï¼Œä¾‹å¦‚ `deployer`ï¼š

```bash
$ useradd -d /home/deployer -s /bin/bash -m deployer
```

å…¶ä¸­ï¼Œ`/home/deployer` ä¸ºç”¨æˆ·å®¶ç›®å½•ï¼ˆä¹Ÿå°±æ˜¯ç™»å½•åˆ°æœåŠ¡å™¨åé»˜è®¤æ‰€åœ¨çš„å½“å‰ç›®å½•ï¼‰ï¼Œ`/bin/bash` ä¸ºç”¨æˆ·çš„é»˜è®¤ Shell ç¨‹åºã€‚

æ¥ç€å°†ç”¨æˆ·æ·»åŠ è‡³ç”¨æˆ·ç»„ï¼š

```bash
$ usermod -a -G deployment -G www-data deployer
```

> æ³¨æ„ï¼šæ­¤å¤„ä½¿ç”¨äº†ä¸¤æ¬¡ -G å‚æ•°ï¼Œå°†è¯¥ç”¨æˆ·åˆ†åˆ«æ·»åŠ è‡³ deployment å’Œ www-data ç”¨æˆ·ç»„ã€‚

æœ€åï¼Œä¸ºæ–°ç”¨æˆ·è®¾ç½®å¯†ç ï¼š

```bash
$ passwd deployer
```

æ ¹æ®æç¤ºè¾“å…¥å¯†ç å¹¶ç¡®è®¤ï¼š

```
Enter new UNIX password: <è¾“å…¥å¯†ç >
Retype new UNIX password: <å†æ¬¡è¾“å…¥å¯†ç >
```

å¥½äº†ï¼Œæ–°ç”¨æˆ·é…ç½®å®Œæˆã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ‡æ¢è‡³ `deployer` ç”¨æˆ·ï¼š

```bash
$ su deployer
```

åŒç†ï¼Œä¹Ÿå¯åˆ‡æ¢ä¸ºå…¶å®ƒç”¨æˆ·ï¼Œä¾‹å¦‚ `root`ï¼š

```bash
$ su root
```

## æµ‹è¯•æ•ˆæœ

æ–­å¼€ SSH è¿æ¥ï¼Œåœ¨æœ¬åœ°ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä½œä¸º `deployer` ç”¨æˆ·ç™»å½•åˆ°æœåŠ¡å™¨ï¼š

```bash
$ ssh deployer@laravel-deployment.wi1dcard.cn
```

å¦‚ä½ æ‰€è§ï¼Œå°†åŸå…ˆçš„ `root` æ›¿æ¢ä¸ºæ–°ç”¨æˆ·åå³å¯ã€‚éšåï¼Œè¾“å…¥ä¸Šæ–‡ä¸­è®¾ç½®çš„å¯†ç ï¼š

```
deployer@laravel-deployment.wi1dcard.cn's password: <è¾“å…¥å¯†ç >
```

è‹¥èƒ½å¤ŸæˆåŠŸç™»å½•ï¼Œåˆ™å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥äº†ã€‚

> æ³¨æ„ï¼šåŠ¡å¿…ç¡®ä¿ç™»å½•æˆåŠŸï¼Œå¦åˆ™ä¸‹ä¸€æ­¥å®Œæˆåä½ å°†æ— æ³•ç™»å½•åˆ°æœåŠ¡å™¨ï¼

## ç¦æ­¢æ ¹ç”¨æˆ· SSH ç™»å½•

ä»¥ä¸Šæˆ‘ä»¬å·²ç»åˆ›å»ºäº†æ–°ç”¨æˆ·ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç¦æ­¢æ ¹ç”¨æˆ·ç›´æ¥é€šè¿‡ SSH ç™»å½•åˆ°æœåŠ¡å™¨ã€‚è‹¥éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œå¯ç™»å½•åé€šè¿‡ `su` å‘½ä»¤åˆ‡æ¢è‡³ `root` æ‰§è¡Œã€‚

é¦–å…ˆï¼Œè¯·æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
$ sed -i -E 's/#?\s*(PermitRootLogin)(.*)$/\1 no/' /etc/ssh/sshd_config
```

å…¶ä¸­ï¼š

- `sed` æ˜¯ä¸€æ¬¾ååˆ†æµè¡Œçš„æµæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œå…·å¤‡æŸ¥æ‰¾ã€æ›¿æ¢ç­‰åŠŸèƒ½ï¼›ä¸å…ˆå‰æåˆ°çš„ `grep` ç±»ä¼¼ï¼Œä½†ç›¸æ¯”ä¹‹ä¸‹ sed æ›´åŠ å¼ºå¤§ã€‚è¯¥ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ä¾¿æ˜¯å®ƒçš„ **æ›¿æ¢** åŠŸèƒ½ã€‚
- `/etc/ssh/sshd_config` æ˜¯è¢«ç¼–è¾‘çš„æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ SSH çš„é…ç½®ã€‚
- `'s/#?\s*(PermitRootLogin)(.*)$/\1 no/'` æ˜¯æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå®ƒæ˜¯ä¸€ä¸ª sed è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºå°† `PermitRootLogin` é…ç½®é¡¹è®¾ç½®ä¸º `no`ã€‚æ­¤å¤„ä¸å†è¯¦ç»†å±•å¼€ï¼Œæœ‰å…´è¶£å¯è‡ªè¡Œæœç´¢ç›¸å…³è¯­æ³•ã€‚
- `-i` è¡¨ç¤ºç›´æ¥æ›¿æ¢æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸æ˜¯å°†æ›¿æ¢åçš„ç»“æœè¾“å‡ºã€‚
- `-E` è¡¨ç¤ºä½¿ç”¨æ‰©å±•ç‰ˆæ­£åˆ™è¯­æ³•ï¼Œæ”¯æŒæ›´å¤šè§„åˆ™ã€‚

ä»¥ä¸Šå‚æ•°çš„ç»†èŠ‚å¯ä¸å¿…æ·±ç©¶ï¼Œåªéœ€æ˜ç™½å®ƒçš„ä½œç”¨å³å¯ã€‚

ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ `/etc/ssh/sshd_config` æ–‡ä»¶ï¼Œæœç´¢ `PermitRootLogin` è¿™ä¸€å…³é”®å­—ï¼Œå°† **æ•´è¡Œ** ä¿®æ”¹ä¸ºï¼š

```
PermitRootLogin no
```

> æ³¨æ„ï¼šåŠ¡å¿…ç¡®ä¿æ•´è¡Œä¿®æ”¹ï¼Œé¦–å°¾æ— å¤šä½™å­—ç¬¦ï¼ˆä¾‹å¦‚æ³¨é‡Šç¬¦ `#`ï¼‰ã€‚

> æç¤ºï¼šè™½ç„¶è¯¾ç¨‹å†…å°½å¯èƒ½åœ°å‡è®¾ä½ ä¸ä¼šä½¿ç”¨ Vim / Emacs ç­‰æ–‡æœ¬ç¼–è¾‘å™¨ï¼Œä½†è¿˜æ˜¯å¼ºçƒˆå»ºè®®å­¦ä¹ ä¸€ä¸‹å®ƒä»¬ï¼Œå“ªæ€•ç®€å•åœ°äº†è§£ä¸€éƒ¨åˆ†ç”¨æ³•ä¹Ÿä¼šå¸¦æ¥æé«˜çš„æ•ˆç‡æå‡ã€‚

éšåï¼Œé‡å¯ SSH æœåŠ¡å³å¯ï¼š

```bash
$ service ssh restart
```

## å†æ¬¡æµ‹è¯•æ•ˆæœ

åœ¨æœ¬åœ°æ‰§è¡ŒåŸå…ˆçš„ç™»å½•å‘½ä»¤ï¼š

```bash
$ ssh root@laravel-deployment.wi1dcard.cn
```

è¾“å…¥å¯†ç åå°†ä¼šæŠ¥é”™ï¼š

```
root@laravel-deployment.wi1dcard.cn's password: <è¾“å…¥å¯†ç >
Permission denied, please try again.
```

æ„ä¸ºæƒé™è¢«æ‹’ç»ï¼Œè¯·å†è¯•ä¸€æ¬¡ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œé‡è¯•ä¹Ÿä¸ä¼šèµ·ä½œç”¨çš„ã€‚
